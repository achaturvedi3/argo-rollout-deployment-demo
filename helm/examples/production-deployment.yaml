# Production Deployment Configuration
# This configuration includes all production-ready features

namespace: production

image:
  repository: 123456789012.dkr.ecr.us-east-1.amazonaws.com/canary-demo
  tag: "v1.2.3"
  pullPolicy: Always

imagePullSecrets:
  - name: ecr-registry-secret

rollout:
  enabled: true
  replicas: 5
  revisionHistoryLimit: 5
  
  resources:
    requests:
      memory: "128Mi"
      cpu: "200m"
    limits:
      memory: "256Mi"
      cpu: "500m"
  
  strategy:
    canary:
      steps:
        - setWeight: 10
          pause:
            duration: 5m
        - setWeight: 25
          pause:
            duration: 5m
        - setWeight: 50
          pause:
            duration: 10m
        - setWeight: 75
          pause:
            duration: 5m
        - setWeight: 100
          pause:
            duration: 1m
      
      autoPromotionEnabled: false  # Manual promotion in production
      autoPromotionSeconds: 0
      abortScaleDownDelaySeconds: 60
      scaleDownDelaySeconds: 60

service:
  type: ClusterIP
  port: 80

ingress:
  enabled: true
  className: alb
  annotations:
    # ALB Configuration
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/backend-protocol: HTTP
    
    # Health Checks
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "15"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "3"
    
    # SSL/TLS
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    
    # Load Balancer Attributes
    alb.ingress.kubernetes.io/load-balancer-attributes: |
      idle_timeout.timeout_seconds=60,
      deletion_protection.enabled=true,
      access_logs.s3.enabled=true,
      access_logs.s3.bucket=my-alb-logs-bucket,
      access_logs.s3.prefix=canary-demo
    
    # Tags
    alb.ingress.kubernetes.io/tags: |
      Environment=production,
      Application=canary-demo,
      Team=platform,
      CostCenter=engineering,
      ManagedBy=helm
    
    # Group ALBs (optional - share single ALB with other apps)
    # alb.ingress.kubernetes.io/group.name: "production-alb"
    # alb.ingress.kubernetes.io/group.order: "10"
  
  hosts:
    - host: app.example.com
      paths:
        - path: /
          pathType: Prefix
    - host: www.app.example.com
      paths:
        - path: /
          pathType: Prefix

aws:
  region: us-east-1
  
  vpc:
    subnets: "subnet-12345678,subnet-23456789,subnet-34567890"
  
  certificate:
    arn: "arn:aws:acm:us-east-1:123456789012:certificate/abcd1234-5678-90ef-ghij-klmnopqrstuv"
  
  waf:
    enabled: true
    arn: "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/production-waf/12345678-1234-1234-1234-123456789012"

externalDns:
  enabled: true
  annotations:
    external-dns.alpha.kubernetes.io/hostname: app.example.com,www.app.example.com
    external-dns.alpha.kubernetes.io/ttl: "300"

route53:
  hostedZoneId: "Z1234567890ABC"
  domainName: "example.com"
  ttl: 300

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 101
  fsGroup: 101
  seccompProfile:
    type: RuntimeDefault

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 101
  capabilities:
    drop:
      - ALL
    add:
      - NET_BIND_SERVICE

serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/canary-demo-prod-role

nodeSelector:
  kubernetes.io/os: linux
  node.kubernetes.io/instance-type: t3.medium

tolerations:
  - key: "production"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - canary-demo
          topologyKey: kubernetes.io/hostname
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 1
        preference:
          matchExpressions:
            - key: node.kubernetes.io/lifecycle
              operator: In
              values:
                - normal

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "80"
  prometheus.io/path: "/metrics"

podLabels:
  environment: production
  team: platform
  version: v1.2.3

argoRollouts:
  enabled: true
  trafficRouting: alb

monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
